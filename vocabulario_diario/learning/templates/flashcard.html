{% extends "base.html" %}

{% block title %}Sessão de Estudo{% endblock %}

{% block content %}
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>
      {% if is_training_session %}
        Sessão de Treino Focado
      {% else %}
        Sessão de Estudo
      {% endif %}
    </h2>
    
    {% if not is_training_session %}
    <div class="session-score" style="text-align: right;">
      <span style="display: block; font-size: 0.9em;">Placar de Hoje:</span>
      <span title="Acertos na sessão" style="color: green; font-weight: bold;">✅ <span id="session-correct-count">0</span></span>
      <span title="Erros (enviados para treino)" style="color: red; font-weight: bold; margin-left: 10px;">❌ <span id="session-incorrect-count">0</span></span>
    </div>
    {% endif %}
  </div>
  
  <div 
    class="flashcard" 
    id="flashcard-container"
    data-next-url="{% if is_training_session %}{% url 'training_session' set_id %}{% else %}{% url 'study_session' %}{% endif %}"
    data-is-training="{{ is_training_session }}"
  >
    <h3>Qual a tradução de:</h3>
    <h1>{{ word.text_english }}</h1>
    
    <form id="answer-form">
      {% csrf_token %}
      <input type="hidden" name="word_id" value="{{ word.id }}">
      <input type="text" id="user-answer-input" name="user_answer" placeholder="Digite sua resposta aqui" required autofocus>
      <button type="submit">Verificar</button>
    </form>
    
    <div id="feedback-section" style="margin-top: 20px;"></div>
  </div>

  <hr>
  <a href="{% url 'home' %}">Parar e Voltar para a Home</a>
{% endblock %}


{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('flashcard-container');
    if (!container) return;

    const proximoCartaoUrl = container.dataset.nextUrl;
    const IS_TRAINING_SESSION = container.dataset.isTraining === 'True';
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

    if (!IS_TRAINING_SESSION) {
        const correctSpan = document.getElementById('session-correct-count');
        const incorrectSpan = document.getElementById('session-incorrect-count');
        let acertos = 0, erros = 0;

        const carregarPlacar = () => {
            const hoje = new Date().toLocaleDateString();
            const dataSalva = localStorage.getItem('placarData');
            if (dataSalva === hoje) {
                acertos = parseInt(localStorage.getItem('placarAcertos')) || 0;
                erros = parseInt(localStorage.getItem('placarErros')) || 0;
            } else {
                localStorage.setItem('placarData', hoje);
                localStorage.setItem('placarAcertos', '0');
                localStorage.setItem('placarErros', '0');
            }
            correctSpan.textContent = acertos;
            incorrectSpan.textContent = erros;
        };

        window.salvarAcerto = () => { acertos++; localStorage.setItem('placarAcertos', acertos); correctSpan.textContent = acertos; };
        window.salvarErro = () => { erros++; localStorage.setItem('placarErros', erros); incorrectSpan.textContent = erros; };
        
        carregarPlacar();
    }

    const handleFetch = (url, body) => {
        return fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify(body)
        }).then(res => res.json());
    };

    const answerForm = document.getElementById('answer-form');
    if (answerForm) {
        answerForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const userAnswer = document.getElementById('user-answer-input').value;
            const wordId = this.querySelector('input[name="word_id"]').value;

            handleFetch("{% url 'check_answer' %}", { 'word_id': wordId, 'user_answer': userAnswer })
            .then(data => {
                answerForm.style.display = 'none';
                const feedbackSection = document.getElementById('feedback-section');
                const formattedCorrectAnswer = data.correct_answer.charAt(0).toUpperCase() + data.correct_answer.slice(1);
                const formattedUserAnswer = userAnswer.charAt(0).toUpperCase() + userAnswer.slice(1);

                if (data.correct) {
                    if (!IS_TRAINING_SESSION) window.salvarAcerto();
                    feedbackSection.innerHTML = `<h3 style="color: green;">✅ Correto!</h3><p>Você digitou: "<strong>${formattedUserAnswer}</strong>"</p><p>A resposta é "<strong>${formattedCorrectAnswer}</strong>".</p><a href="${proximoCartaoUrl}" class="button" style="margin-top: 10px;">Ir para o próximo cartão</a>`;
                } else {
                    feedbackSection.innerHTML = `<h3 style="color: red;">❌ Incorreto.</h3><p>Você digitou: "<strong>${formattedUserAnswer}</strong>"</p><p>A resposta certa era: "<strong>${formattedCorrectAnswer}</strong>"</p><div style="margin-top: 15px;"><button id="define-correct-btn" data-word-id="${wordId}" class="button">Definir como correta</button><button id="confirm-error-btn" class="button" style="background-color: #c9302c;">Confirmar Erro</button></div>`;
                }
            });
        });
    }

    const feedbackSection = document.getElementById('feedback-section');
    if(feedbackSection) {
        feedbackSection.addEventListener('click', function(event) {
            const target = event.target;
            const wordId = target.dataset.wordId;

            if (target.id === 'define-correct-btn') {
                if (!IS_TRAINING_SESSION) window.salvarAcerto();
                handleFetch("{% url 'mark_as_correct' %}", { 'word_id': wordId })
                .then(data => { if (data.status === 'success') window.location.href = proximoCartaoUrl; });
            }
            if (target.id === 'confirm-error-btn') {
                if (!IS_TRAINING_SESSION) window.salvarErro();
                window.location.href = proximoCartaoUrl;
            }
        });
    }
});
</script>
{% endblock script %}