{% extends "base.html" %}

{% block title %}Sess√£o de Estudo{% endblock %}

{% block extra_css %}{% endblock extra_css %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-9 col-xl-8">

            <div class="text-center mb-4">
                <h2 class="text-white fw-light display-6">
                    {% if is_training_session %}
                        üèãÔ∏è Sess√£o de Treino Focado
                    {% else %}
                        üìö Sess√£o de Estudo
                    {% endif %}
                </h2>
            </div>
            
            {% if is_training_session %}
            <div class="row justify-content-center mb-4 text-white-50">
                <div class="col-auto text-center">
                    <span style="font-size: 1.2em; font-weight: bold;">{{ palavras_respondidas|default:0 }} / {{ total_palavras_no_conjunto|default:0 }}</span>
                    <small style="display: block;">Progresso do Conjunto</small>
                </div>
            </div>
            {% else %}
            <div class="row justify-content-center mb-4 text-white-50">
                <div class="col-auto text-center"><div class="fs-1">‚úÖ</div><div class="fs-3 fw-bold" id="session-correct-count">0</div><small>Acertos</small></div>
                <div class="col-auto text-center ms-4"><div class="fs-1">‚ùå</div><div class="fs-3 fw-bold" id="session-incorrect-count">0</div><small>Erros</small></div>
            </div>
            {% endif %}

            <div class="card shadow-lg border-0">
                <div class="card-body p-4 p-sm-5 text-center">
                    <div id="flashcard-content">
                        <h3 class="text-muted mb-3">Qual a tradu√ß√£o de:</h3>
                        <h1 class="word-display mb-4">{{ word.text_english }}</h1>
                        
                        <form id="answer-form">
                            {% csrf_token %}
                            <input type="hidden" name="word_id" value="{{ word.id }}">
                            <input type="text" id="user-answer-input" class="form-control form-control-lg text-center mb-3" placeholder="Digite sua resposta aqui" required autofocus autocomplete="off">
                            <button type="submit" class="btn gradient-btn text-white btn-lg w-100">Verificar</button>
                        </form>
                        
                        <div id="feedback-section" style="margin-top: 20px;"></div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4"><a href="{% url 'home' %}" class="btn btn-outline-light btn-sm">‚Üê Parar Sess√£o</a></div>
        </div>
    </div>
</div>
{% endblock %}


{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('flashcard-content');
    if (!container) return;

    // --- L√ìGICA DE DEFINI√á√ÉO DE URL E SESS√ÉO ---
    // (Aten√ß√£o: A l√≥gica do proximoCartaoUrl depende das suas rotas de URL e do set_id)
    const proximoCartaoUrl = "{% if is_training_session %}{% url 'training_session' set_id %}{% else %}{% url 'study_session' %}{% endif %}";
    const IS_TRAINING_SESSION = container.parentElement.parentElement.parentElement.innerHTML.includes("Sess√£o de Treino Focado"); // Forma alternativa de verificar

    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

    // --- L√ìGICA DO PLACAR DI√ÅRIO ---
    if (!IS_TRAINING_SESSION) {
        // ... (c√≥digo do placar) ...
    }

    // --- MANIPULADOR DE SUBMISS√ÉO DO FORMUL√ÅRIO ---
    const answerForm = document.getElementById('answer-form');
    if (answerForm) {
        answerForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const userAnswerInput = document.getElementById('user-answer-input');
            const userAnswer = userAnswerInput.value;
            const wordId = this.querySelector('input[name="word_id"]').value;

            fetch("{% url 'check_answer' %}", { method: 'POST', body: JSON.stringify({ 'word_id': wordId, 'user_answer': userAnswer }), headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken } })
            .then(response => response.json())
            .then(data => {
                if (!data) return; 
                answerForm.style.display = 'none';
                const feedbackSection = document.getElementById('feedback-section');
                const formattedCorrectAnswer = data.correct_answer.charAt(0).toUpperCase() + data.correct_answer.slice(1);
                const formattedUserAnswer = userAnswer.charAt(0).toUpperCase() + userAnswer.slice(1);

                if (data.correct) {
                    feedbackSection.innerHTML = `
                        <h4 class="text-success fw-bold">‚úÖ Correto!</h4>
                        <p>Voc√™ digitou: "<strong>${formattedUserAnswer}</strong>"</p>
                        <p>A resposta √©: "<strong>${formattedCorrectAnswer}</strong>".</p>
                        <a href="${proximoCartaoUrl}" class="btn gradient-btn text-white mt-3 w-100 btn-lg">Pr√≥ximo Cart√£o</a>
                    `;
                } else {
                    feedbackSection.innerHTML = `
                        <h4 class="text-danger fw-bold">‚ùå Incorreto.</h4>
                        <p>Voc√™ digitou: "<strong>${formattedUserAnswer}</strong>"</p>
                        <p>A resposta certa era: "<strong>${formattedCorrectAnswer}</strong>"</p>
                        <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button id="define-correct-btn" data-word-id="${wordId}" class="btn btn-outline-success w-100 btn-lg">Definir como correta</button>
                            <button id="confirm-error-btn" class="btn btn-danger w-100 btn-lg">Confirmar Erro</button>
                        </div>
                    `;
                }
            });
        });
    }

    // --- DELEGA√á√ÉO DE EVENTOS PARA BOT√ïES DE FEEDBACK ---
    const feedbackSection = document.getElementById('feedback-section');
    if(feedbackSection) {
        feedbackSection.addEventListener('click', function(event) {
            const target = event.target;
            const wordId = target.dataset.wordId;
            const handleFetch = (url, body) => fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, body: JSON.stringify(body) }).then(res => res.json());

            if (target.id === 'define-correct-btn') {
                if (!IS_TRAINING_SESSION && window.salvarAcerto) window.salvarAcerto();
                handleFetch("{% url 'mark_as_correct' %}", { 'word_id': wordId })
                .then(data => { if (data && data.status === 'success') window.location.href = proximoCartaoUrl; });
            }
            if (target.id === 'confirm-error-btn') {
                if (!IS_TRAINING_SESSION && window.salvarErro) window.salvarErro();
                window.location.href = proximoCartaoUrl;
            }
        });
    }
});
</script>
{% endblock script %}